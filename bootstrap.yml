#
# Top level bootstrap file
#
---
- hosts: all

  tasks:

### REDHAT
# obsolete
#    - name: Install python-simplejson
#      raw: yum -y install python-simplejson
#      when: ansible_os_family == "RedHat"
#      tags:
#        - packages
#        - json

    - name: Install packages
      yum: name={{item}}
           state=installed
      with_items:
        - sudo
        - libselinux-python
      when: ansible_os_family == "RedHat"
      tags:
        - packages
        - sudo


### DEBIAN
    - name: Install python-simplejson
      raw: apt-get -y install python-simplejson
      when: ansible_os_family == "Debian"
      tags:
        - packages

    - name: Install packages
      apt: name={{item}}
           state=installed
      with_items:
        - sudo
      when: ansible_os_family == "Debian"
      tags:
        - packages
        - sudo


### ADMIN USER
# centos debian gid mismatch: uucp vs wheel
    - name: Create wheel group
      group: name=wheel
             gid=14
             system=yes
      when: ansible_os_family == "Debian"
      tags:
        - wheel

    - name: Create System Operator
      user: name=sysop
            comment='System Operator'
            groups=wheel
            password=*
            shell=/bin/bash
      tags:
        - wheel

### SUDO
    - name: Sudo for the wheel group
      lineinfile: dest=/etc/sudoers.d/wheel line="%wheel ALL=(ALL) NOPASSWD:ALL"
                  create=yes
                  state=present
                  regexp='^%wheel'
                  backup=yes
      tags:
        - sudo
        - wheel

    - name: Set mode for /etc/sudoers.d/wheel
      file: path=/etc/sudoers.d/wheel
            owner=root
            group=root
            mode=0440
      tags:
        - sudo
        - wheel

    - name: 
      authorized_key: user=sysop
                      key="{{ lookup('file', 'keys/sysop.pub') }}"
                      manage_dir=yes
      tags:
        - ssh
        - keys


    - name: Bootstrap done
      lineinfile: dest=/etc/ANSIBLE_STATE
                  regexp="^bootstrap"
                  line=bootstrap
                  state=present
                  create=yes
      tags:
        - state
