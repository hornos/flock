#!/bin/bash
# CM tool

### init
gdn=$(cd $(dirname $0); pwd)
usrlocal=/usr
if [ ! -z "${OSTYPE/darwin/}" ]; then
  usrlocal=/usr/local
fi

cm="cloudmonkey -c ${CMONKEY_HOSTS}"

### main
cmd=${1:-help}
shift

# http://www.commandlinefu.com/commands/view/3584/remove-color-codes-special-characters-with-sed

# linux: sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})*)?m//g"
# osx: sed -E "s/"$'\E'"\[([0-9]{1,2}(;[0-9]{1,2})*)?m//g"

### args
case ${cmd} in
  inv2inv)
    name=${1:-test}
    fqdn=${2:-test}
    inventory="./inventory/${name}.ansible"
    ip=$(${cm} list virtualmachines name=${name} | \
    grep ipaddress | \
    head -1 | awk '{print $3}' | \
    sed -E "s/"$'\E'"\[([0-9]{1,3}((;[0-9]{1,3})*)?)?[m|K]//g")	
    echo "[${name}]" > ${inventory}
    echo "${fqdn} ansible_ssh_host=${ip} ansible_connection=paramiko" >> ${inventory}
  ;;
esac
